<% content_for(:head) do %>
  <script type="text/javascript">
    fcms.currentCategory = [];

    $(document).ready(function() {
      // Hide the planification section
      $('#section-2').hide();

      // On category selection
      $('#input-planned-category').on('change', function() {
        var selectedOption = $(this).children("option:selected");
        var categoryId = selectedOption.attr('value');
        var categoryName = selectedOption.text();
        if (!categoryId || categoryId < 0) {
          $('#section-2').hide('fast');
          return;
        }

        $.ajax({
          url: "http://localhost:3000/admin/planification/categories/" + categoryId,
          success: function(data) {
            fcms.currentCategory = data;

            var tsInput = $('#input-timeslot-id');
            tsInput.find('option').remove().end().append('<option></option>');
            _.each(fcms.currentCategory.timeslots, function(ts) {
              $('<option></option>').attr('value', ts.id).text(ts.label).appendTo(tsInput);
            });

            $('.panel:not(#panel-categories)').hide();
            $('#section-2').show('fast');
          },
          error: function() {
            alert("Les sous-catégories pour la classe " + categoryName + " n'ont pas pu être chargées.")
          }
        })
      });

      // On timeslot selection
      $('#input-timeslot-id').on('change', function() {
        var selectedOption = $(this).children("option:selected");
        var timeslotId = selectedOption.attr('value');
        var timeslotName = selectedOption.text();
        if (!timeslotId || timeslotId < 0) {
          $('.panel:not(#panel-categories)').hide('fast');
          return;
        }

        $.ajax({
          url: "http://localhost:3000/admin/planification/timeslots/" + timeslotId,
          success: function(data) {
            loadTimeslot(data);
            $('.panel:not(#panel-categories)').show('fast');
          },
          error: function() {
            alert("La sous-catégorie " + timeslotName + " n'a pas pu être chargée.");
          }
        });
      });

      // Enable select-all and select-none buttons
      $('#btn-select-all-down') .click(function() { $('#table-inscriptions-selected tr').addClass('selected'); });
      $('#btn-select-none-down').click(function() { $('#table-inscriptions-selected tr').removeClass('selected'); });

      $('#btn-select-all-up')   .click(function() { $('#table-inscriptions-all tr').addClass('selected'); });
      $('#btn-select-none-up')  .click(function() { $('#table-inscriptions-all tr').removeClass('selected'); });

      // Enable arrow buttons
      $('#btn-move-all-down')       .click(function() { $('#table-inscriptions-selected tr').appendTo('#table-inscriptions-all'); });
      $('#btn-move-selected-down')  .click(function() { $('#table-inscriptions-selected tr.selected').appendTo('#table-inscriptions-all'); });
      $('#btn-move-all-up')         .click(function() { $('#table-inscriptions-all tr').appendTo('#table-inscriptions-selected'); });
      $('#btn-move-selected-up')    .click(function() { $('#table-inscriptions-all tr.selected').appendTo('#table-inscriptions-selected'); });

      // Enable mouse table draggers
      $(document).on('mousedown', '.table-dragger', function(e){
        var id = $(this).data('for-table');
        var tbody = $('#'+id).parent('.dataTables_scrollBody');

        var sH = tbody.height();
        var sX = e.pageY;

        $(document).on('mouseup', function(me){
          $(document).off('mouseup').off('mousemove');
        });

        $(document).on('mousemove', function(me){
          tbody.height(sH - (sX - me.pageY));
        });
      });
    });

  </script>

<% end %>


<h3><i class="icon-calendar"></i> Planifier le concours <span style="float: right;">
  <!--<button class="btn btn-primary">Télécharger au format Microsoft Excel</button>-->
  <%# button_to "Télécharger au format Microsoft Excel", class: "btn btn-primary" ,  action: "admin/planification#ProduceExcel"  %>

  <a href="<%=  admin_ProduceExcel_path %>" class="btn btn-primary" >Télécharger au format Microsoft Excel</a>
</span></h3>
<div class="form-inline" id="section-1">
  <label for="input-planned-category">Sélectionner la classe à planifier: </label>&nbsp;&nbsp;
  <%= select_tag 'input-planned-category', options_from_collection_for_select(Category.all(:order => "name ASC"), 'id', 'name'), :include_blank => true %>
</div>

<div id="section-2">
  <hr>

  <div class="panel" id="panel-categories">
    <h4>Catégories d'inscription</h4>
    <div class="form-inline">
      <label for="input-timeslot-id">Catégorie d'inscription: </label>&nbsp;&nbsp;
      <select id="input-timeslot-id"><option></option><option>Récital piano 14 ans</option></select>
      <a class="btn btn-small btn-success" href="#"><i class="icon-plus"></i></a>
      <a class="btn btn-small btn-danger " href="#"><i class="icon-minus"></i></a>
    </div>
  </div>

  <div class="panel" id="panel-selected">
    <hr>

    <h4>Détails de la catégorie</h4>

    <div class="input-prepend">
      <span class="add-on">Nom de la catégorie</span>
      <input id="input-timeslot-name" type="text" value="Récital piano 14 ans">
    </div>

    <h4>Inscriptions dans cette catégorie</h4>
    <div id="div-inscriptions-selected"></div>

  </div>

  <div class="panel" id="panel-controls">
    <div class="sub-controls" id="sub-controls-down">
      <div class="sub-controls-left">
        <button class="btn btn-mini" id="btn-select-all-down">Sélectionner tout</button>&nbsp;<button class="btn btn-mini" id="btn-select-none-down">Désélectionner tout</button>
      </div>
      <div class="sub-controls-right">
        <button class="btn btn-mini" id="btn-move-all-down"><i class="icon-arrow-down"></i></button>&nbsp;<button class="btn btn-mini" id="btn-move-selected-down"><i class="icon-chevron-down"></i></button>
      </div>
      <div class="clear"></div>
    </div>
    <div class="sub-controls" id="sub-controls-up">
      <div class="sub-controls-left">
        <button class="btn btn-mini" id="btn-move-selected-up"><i class="icon-chevron-up"></i></button>&nbsp;<button class="btn btn-mini" id="btn-move-all-up"><i class="icon-arrow-up"></i></button>
      </div>
      <div class="sub-controls-right">
        <button class="btn btn-mini" id="btn-select-all-up">Sélectionner tout</button>&nbsp;<button class="btn btn-mini" id="btn-select-none-up">Désélectionner tout</button>
      </div>
      <div class="clear"></div>
    </div>
  </div>

  <div class="panel" id="panel-all">
    <h4>Toutes les inscriptions pour la classe <strong>Récital</strong></h4>
    <div id="div-inscriptions-all"></div>

  </div>

</div>